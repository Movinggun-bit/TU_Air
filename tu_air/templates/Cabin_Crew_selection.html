{% extends "base.html" %}
{% block title %}{{ title }} ì„ íƒ - ê´€ë¦¬ì{% endblock %}

{% block content %}
<div class="aircraft-selection-container">
    <div class="aircraft-selection-header">
        <h1>{{ title }} ì„ íƒ</h1>
        <p class="aircraft-selection-subtitle">ë°°ì •í•  ìŠ¹ë¬´ì› 2ëª…ì„ ì„ íƒí•˜ì„¸ìš”.</p>
    </div>

    <!-- ì„ íƒëœ ìŠ¹ë¬´ì›ì´ í‘œì‹œë  ì˜ì—­ -->
    <div id="selected_crew_area" class="selected-crew-container">
        <div id="selected_cards_wrapper" style="display: flex; justify-content: space-between; flex-wrap: wrap;">
            <!-- Selected crew cards will be moved here by JS -->
        </div>
        <div id="selection_complete_wrapper" style="display: none; margin-top: 20px; text-align: center;">
            <button class="btn-register-submit" onclick="selectMultipleCrew()">2ëª… ì„ íƒ ì™„ë£Œ</button>
        </div>
    </div>

    {% if staffs %}
    <section class="aircraft-category">
        <div class="category-header">
            <h2 class="category-title">
                <span class="category-icon">ğŸ‘¥</span>
                {{ title }} ëª©ë¡
                <span class="category-badge">{{ staffs|length }}ëª…</span>
            </h2>
        </div>
        <div class="aircraft-grid" id="crew_grid">
            {% for staff in staffs %}
            <div class="aircraft-card" id="card-{{ staff.Staff_ID }}">
                <div class="aircraft-card-header">
                    <h3 class="aircraft-model">{{ staff.Name }}</h3>
                    <span class="aircraft-id">ID: {{ staff.Staff_ID }}</span>
                </div>
                <div class="aircraft-card-body">
                    <div class="aircraft-info-item">
                        <span class="info-label">ë¶€ì„œ</span>
                        <span class="info-value">{{ staff.Department }}</span>
                    </div>
                    <div class="aircraft-info-item">
                        <span class="info-label">ì—­í• </span>
                        <span class="info-value highlight">{{ staff.Role }}</span>
                    </div>
                </div>
                <div class="aircraft-card-footer">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="crew-checkbox" 
                               data-id="{{ staff.Staff_ID }}" 
                               data-name="{{ staff.Name }}"
                               onchange="handleCheckboxChange(this)">
                        <label>ì„ íƒ</label>
                    </div>
                    <a href="{{ url_for('admin.staff_schedule', staff_id=staff.Staff_ID) }}" class="btn-aircraft-details">
                        ì¼ì • ë³´ê¸°
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% else %}
    <div class="aircraft-empty-state">
        <p>ë“±ë¡ëœ {{ title }}ì´(ê°€) ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const selectedCardsWrapper = document.getElementById('selected_cards_wrapper'); // New wrapper for selected cards
    const crewGrid = document.getElementById('crew_grid');
    const completeButtonWrapper = document.getElementById('selection_complete_wrapper');

    function handleCheckboxChange(checkbox) {
        const card = checkbox.closest('.aircraft-card');
        const selectedCount = selectedCardsWrapper.querySelectorAll('.aircraft-card').length; // Count from new wrapper

        if (checkbox.checked) {
            if (selectedCount >= 2) {
                checkbox.checked = false; // Prevent 3rd selection
                alert('ìµœëŒ€ 2ëª…ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            // Move card to the new selected cards wrapper
            selectedCardsWrapper.appendChild(card);
            card.style.width = '45%'; // Apply width when selected
        } else {
            // Move card back to the main grid
            crewGrid.prepend(card);
            card.style.width = ''; // Remove width when unselected
        }
        updateUi();
    }

    function updateUi() {
        const newSelectedCount = selectedCardsWrapper.querySelectorAll('.aircraft-card').length; // Count from new wrapper
        if (newSelectedCount === 2) {
            completeButtonWrapper.style.display = 'block';
        } else {
            completeButtonWrapper.style.display = 'none';
        }
    }

    function selectMultipleCrew() {
        const selectedCards = selectedCardsWrapper.querySelectorAll('.aircraft-card'); // Get from new wrapper
        
        if (selectedCards.length !== 2) {
            alert("ì •í™•íˆ 2ëª…ì˜ ìŠ¹ë¬´ì›ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }

        const targets = "{{ target }}".split(',');
        if (targets.length !== 2) {
            alert("ì˜¤ë¥˜: ëŒ€ìƒ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        const selectionData = [];
        selectedCards.forEach((card, index) => {
            const checkbox = card.querySelector('.crew-checkbox');
            selectionData.push({
                target: targets[index],
                id: checkbox.dataset.id,
                name: `(${checkbox.dataset.name})`
            });
        });
        
        sessionStorage.setItem('staff_selection', JSON.stringify(selectionData));
        window.location.href = "{{ url_for('admin.schedule_dashboard') }}";
    }
</script>
{% endblock %}
